name: CCMEWS Climate Alert Service

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  climate-alert-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install requests pandas numpy scikit-learn httpx scipy
      
      - name: Create SMS configuration
        env:
          FROG_API_KEY: ${{ secrets.FROG_API_KEY }}
          FROG_USERNAME: ${{ secrets.FROG_USERNAME }}
          SMS_RECIPIENTS: ${{ secrets.SMS_RECIPIENTS }}
        run: |
          cat > sms_config.json << 'EOF'
          {
            "provider": "frog",
            "frog": {
              "api_key": "$FROG_API_KEY",
              "username": "$FROG_USERNAME",
              "sender_id": "ccmews",
              "use_test_api": false
            },
            "enabled": true,
            "test_mode": false,
            "alert_thresholds": {
              "flood_risk": 0.45,
              "heat_risk": 0.45,
              "drought_risk": 0.45,
              "composite_risk": 0.50,
              "rainfall_mm": 30,
              "temperature_c": 37
            },
            "recipients": $SMS_RECIPIENTS
          }
          EOF
      
      - name: Run CCMEWS Alert Check
        run: python ccmews_scheduler_service.py --run-once
